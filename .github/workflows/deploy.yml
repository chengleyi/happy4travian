name: deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
      - name: Ensure latest main and print commit
        run: |
          git fetch origin main
          git checkout -B main origin/main
          git rev-parse HEAD
          git log -n 1 --pretty='format:COMMIT:%h %s'
      - name: Upload systemd unit
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: ops/systemd/happy4travian.service
          target: /etc/systemd/system/
      - name: Upload DB schema
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: docs/schema.sql
          target: /opt/happy4travian/
      - name: Upload Python backend
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: backend_py/*
          target: /opt/happy4travian/
      - name: Ensure app.py and requirements uploaded
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: backend_py/app.py
          target: /opt/happy4travian/
      - name: Ensure requirements uploaded
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: backend_py/requirements.txt
          target: /opt/happy4travian/
      - name: DB preflight and create tables
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            DB_URL="${{ secrets.DB_URL }}"; DB_USER="${{ secrets.DB_USER }}"; DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            DB_HOST=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://([^/:]+).*|\1|')
            DB_PORT=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://[^/:]+:([0-9]+).*|\1|'); [ -z "$DB_PORT" ] && DB_PORT=3306
            DB_NAME=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://[^/]+/([^?]+).*|\1|')
            sudo yum install -y mariadb || true
            mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\` DEFAULT CHARACTER SET utf8mb4;"
            mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" -e "USE \`$DB_NAME\`; SHOW TABLES; SHOW TABLES LIKE 'game_accounts';"
      - name: Prepare and restart service (Flask)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            sudo mkdir -p /opt/happy4travian /etc/happy4travian
            sudo systemctl stop happy4travian.service || true
            sudo yum install -y python3 python3-pip || true
            python3 -V || true
            sudo python3 -m venv /opt/happy4travian/venv
            /opt/happy4travian/venv/bin/pip install --upgrade pip
            ls -lah /opt/happy4travian || true
            /opt/happy4travian/venv/bin/python -c "import sys; print(sys.version)" || true
            /opt/happy4travian/venv/bin/python -c "import flask, sqlalchemy, pymysql; import gunicorn; print('deps ok')" || true
            if [ -f /opt/happy4travian/requirements.txt ]; then
              /opt/happy4travian/venv/bin/pip install -r /opt/happy4travian/requirements.txt
            else
              echo "requirements.txt not found, installing packages directly (CentOS7 python3.6 compatible)"
              /opt/happy4travian/venv/bin/pip install Flask==2.0.3 gunicorn==20.1.0 SQLAlchemy==1.4.52 pymysql==1.0.2 flask-cors==3.0.10
            fi
            sudo bash -lc 'cat > /etc/happy4travian/happy4travian.env <<EOF
            SPRING_DATASOURCE_URL=${{ secrets.DB_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USER }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
            EOF'
            sudo systemctl daemon-reload
            sudo systemctl enable happy4travian.service
            sudo systemctl restart happy4travian.service
            if systemctl is-active firewalld >/dev/null 2>&1; then sudo firewall-cmd --permanent --add-port=8080/tcp && sudo firewall-cmd --reload; fi
            for i in 1 2 3 4 5; do
              if (ss -ltnp || netstat -ltnp) | grep 8080 >/dev/null 2>&1; then break; fi
              sleep 2
            done
            echo "==> systemctl status"
            sudo systemctl status happy4travian.service --no-pager || true
            echo "==> journalctl tail"
            sudo journalctl -u happy4travian.service -n 200 --no-pager || true
            echo "==> ps gunicorn"
            ps aux | grep gunicorn || true
            curl -s -o /dev/null -w "health:%{http_code}\n" http://127.0.0.1:8080/api/v1/health || true
            curl -s -o /dev/null -w "db:%{http_code}\n" http://127.0.0.1:8080/api/v1/db/ping || true
            sudo ls -lah /opt/happy4travian/app.log || true
            sudo tail -n 100 /opt/happy4travian/app.log || true
      - name: External health probe
        run: |
          echo "==> probe from runner"
          curl -s -o /dev/null -w "HTTP:%{http_code} BYTES:%{size_download}\n" http://47.99.88.168:8080/api/v1/health || true
          curl -s -o /dev/null -w "HTTP:%{http_code} BYTES:%{size_download}\n" http://47.99.88.168:8080/api/v1/db/ping || true
          echo "==> external endpoints"
          curl -s -o /dev/null -w "tribes:%{http_code}\n" http://47.99.88.168:8080/api/v1/tribes || true
          curl -s -o /dev/null -w "accounts:%{http_code}\n" http://47.99.88.168:8080/api/v1/accounts || true
          curl -s -o /dev/null -w "villages:%{http_code}\n" http://47.99.88.168:8080/api/v1/villages || true