# 部署工作流：在 main 分支推送或手触发时执行
name: deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Redeploy marker
        # 标记重部署时间，便于审计
        run: |
          echo "REDEPLOY_TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > redeploy.marker
      - name: Force redeploy note
        run: |
          echo "Force redeploy at $(date -u +%Y-%m-%dT%H:%M:%SZ) on $GITHUB_REF by $GITHUB_ACTOR"
      - name: Restart trigger marker
        run: |
          echo "RESTART_TRIGGER=$(date -u +%s)" > restart.trigger
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
      - name: Ensure latest main and print commit
        # 确保使用最新 main，并打印提交信息
        run: |
          git fetch origin main
          git checkout -B main origin/main
          git rev-parse HEAD
          git log -n 1 --pretty='format:COMMIT:%h %s'
      - name: Upload systemd unit
        # 上传 systemd 单元文件到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: ops/systemd/happy4travian.service
          target: /etc/systemd/system/
      - name: Upload DB schema
        # 上传数据库初始化 SQL 到指定目录
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: docs/schema.sql
          target: /opt/happy4travian/
      - name: Archive backend
        # 将后端目录打包为 tar.gz（便于传输）
        run: |
          tar -czf backend_py.tar.gz backend_py
          ls -lah backend_py.tar.gz
      - name: Upload backend archive
        # 上传后端归档到服务器指定目录
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: backend_py.tar.gz
          target: /opt/happy4travian/
      - name: Upload resource icons
        # 上传前端提供的部落图标拼图到服务器
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: resource/*
          target: /opt/happy4travian/resource/
      - name: Ensure app.py and requirements uploaded
        # 确保关键文件已上传到运行目录
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: backend_py/app.py
          target: /opt/happy4travian/backend_py/
      - name: Ensure requirements uploaded
        # 便于服务器端安装依赖
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: backend_py/requirements.txt
          target: /opt/happy4travian/backend_py/
      - name: DB preflight and create tables
        # 在服务器上创建数据库并检查表
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            DB_URL="${{ secrets.DB_URL }}"; DB_USER="${{ secrets.DB_USER }}"; DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            DB_HOST=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://([^/:]+).*|\1|')
            DB_PORT=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://[^/:]+:([0-9]+).*|\1|'); [ -z "$DB_PORT" ] && DB_PORT=3306
            DB_NAME=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://[^/]+/([^?]+).*|\1|')
            sudo yum install -y mariadb || true
            mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\` DEFAULT CHARACTER SET utf8mb4;"
            mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" -e "USE \`$DB_NAME\`; SHOW TABLES; SHOW TABLES LIKE 'game_accounts';"
      - name: Prepare and restart service (Flask)
        # 准备 Python 环境并重启服务
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            sudo mkdir -p /opt/happy4travian /etc/happy4travian
            sudo mkdir -p /opt/happy4travian/backend_py
            if [ -f /opt/happy4travian/backend_py.tar.gz ]; then
              sudo rm -rf /opt/happy4travian/backend_py
              sudo mkdir -p /opt/happy4travian/backend_py
              sudo tar -xzf /opt/happy4travian/backend_py.tar.gz -C /opt/happy4travian
            fi
            sudo systemctl stop happy4travian.service || true
            # 安装 Tesseract 及中文语言包（尽力而为）
            sudo yum install -y epel-release || true
            sudo yum install -y tesseract tesseract-langpack-chi_sim || true
            sudo dnf install -y tesseract tesseract-langpack-chi_sim || true
            echo "==> unit file before patch"
            sudo sed -n '1,120p' /etc/systemd/system/happy4travian.service || true
            echo "==> select python for ExecStart"
            PY_BIN=""
            if [ -x /opt/happy4travian/mamba/envs/h4t/bin/python ]; then
              PY_BIN=/opt/happy4travian/mamba/envs/h4t/bin/python
            elif [ -x /opt/happy4travian/py311/bin/python ]; then
              PY_BIN=/opt/happy4travian/py311/bin/python
            elif command -v python3.11 >/dev/null 2>&1; then
              PY_BIN=$(command -v python3.11)
            elif command -v python3 >/dev/null 2>&1; then
              PY_BIN=$(command -v python3)
            fi
            echo "PY_BIN=$PY_BIN"
            if [ -n "$PY_BIN" ]; then
              echo "==> inspect python binary"
              ls -lah "$PY_BIN" || true
              file "$PY_BIN" || true
              "$PY_BIN" -V || true
              echo "==> list bin directory"
              ls -lah "$(dirname "$PY_BIN")" || true
            fi
            if [ -z "$PY_BIN" ]; then
              echo "no python found, installing python3.11 via IUS"
              sudo yum install -y https://repo.ius.io/ius-release-el7.rpm || true
              sudo yum install -y python311 python311-pip || true
              PY_BIN=/usr/bin/python3.11
            fi
            # ensure gunicorn and app deps available in selected python
            $PY_BIN -m pip install --upgrade pip || true
            if [ -f /opt/happy4travian/backend_py/requirements.txt ]; then
              $PY_BIN -m pip install -r /opt/happy4travian/backend_py/requirements.txt || true
            fi
            $PY_BIN -m pip install gunicorn || true
            $PY_BIN -m pip install Pillow pytesseract imagehash numpy || true
            $PY_BIN -c 'import sys; print("PY_BIN:", sys.executable); import flask, sqlalchemy, pymysql; import PIL, pytesseract; print("deps ok")' || true
            echo "==> enforce ExecStart (overwrite unit)"
            sudo bash -lc 'cat > /etc/systemd/system/happy4travian.service <<EOF
            [Unit]
            Description=Happy4Travian Backend
            After=network.target
            
            [Service]
            WorkingDirectory=/opt/happy4travian
            EnvironmentFile=/etc/happy4travian/happy4travian.env
            ExecStart='"$PY_BIN"' -m gunicorn --chdir /opt/happy4travian/backend_py -w 2 -b 0.0.0.0:8080 app:app
            Restart=always
            RestartSec=5
            User=root
            LimitNOFILE=65535
            
            [Install]
            WantedBy=multi-user.target
            EOF'
            echo "==> unit file after patch"
            sudo systemctl cat happy4travian.service || true
            echo "==> ExecStart value"
            sudo systemctl show happy4travian.service -p ExecStart || true
            echo "==> install micromamba (static)"
            sudo mkdir -p /opt/happy4travian/micromamba/bin
            if [ ! -x /opt/happy4travian/micromamba/bin/micromamba ]; then
              ARCH=$(uname -m)
              case "$ARCH" in
                x86_64|amd64)
                  MURL="https://micro.mamba.pm/api/micromamba/linux-64/latest";
                  ;;
                aarch64|arm64)
                  MURL="https://micro.mamba.pm/api/micromamba/linux-aarch64/latest";
                  ;;
                *)
                  MURL="https://micro.mamba.pm/api/micromamba/linux-64/latest";
                  ;;
              esac
              echo "micromamba url: $MURL (arch=$ARCH)"
              curl -fsSL "$MURL" -o /tmp/micromamba.tar.bz2
              sudo tar -xjf /tmp/micromamba.tar.bz2 -C /opt/happy4travian/micromamba
              # archive contains bin/micromamba
              sudo chmod +x /opt/happy4travian/micromamba/bin/micromamba
            fi
            MAMBA_BIN=/opt/happy4travian/micromamba/bin/micromamba
            if $MAMBA_BIN --version >/dev/null 2>&1; then
              echo "micromamba ok"
            else
              echo "micromamba not executable, will fallback later"
            fi
            export MAMBA_ROOT_PREFIX=/opt/happy4travian/mamba
            echo "==> create/update env h4t (py311)"
            if $MAMBA_BIN --version >/dev/null 2>&1; then
              $MAMBA_BIN create -y -n h4t python=3.11 || true
              $MAMBA_BIN run -n h4t python -c "import sys; print(sys.version)" || true
              $MAMBA_BIN run -n h4t python -m pip install --upgrade pip
            else
              echo "micromamba unavailable, fallback to IUS Python 3.11"
              sudo yum install -y https://repo.ius.io/ius-release-el7.rpm || true
              sudo yum install -y python311 python311-pip || true
              PY311=/usr/bin/python3.11
              if [ -x "$PY311" ]; then
                sudo "$PY311" -m venv /opt/happy4travian/py311
                /opt/happy4travian/py311/bin/pip install --upgrade pip
                sudo mkdir -p /opt/happy4travian/mamba/envs/h4t/bin
                sudo ln -sf /opt/happy4travian/py311/bin/python /opt/happy4travian/mamba/envs/h4t/bin/python || true
                sudo ln -sf /opt/happy4travian/py311/bin/pip /opt/happy4travian/mamba/envs/h4t/bin/pip || true
              fi
            fi
            ls -lah /opt/happy4travian || true
            ls -lah /opt/happy4travian/backend_py || true
            grep -n "quote_plus" /opt/happy4travian/backend_py/app.py || true
            if $MAMBA_BIN --version >/dev/null 2>&1; then
              $MAMBA_BIN run -n h4t python -c "import sys; print(sys.version)" || true
              $MAMBA_BIN run -n h4t python -c "import flask, sqlalchemy, pymysql; import gunicorn; print('deps ok')" || true
              if [ -f /opt/happy4travian/backend_py/requirements.txt ]; then
                $MAMBA_BIN run -n h4t pip install -r /opt/happy4travian/backend_py/requirements.txt
              elif [ -f /opt/happy4travian/requirements.txt ]; then
                $MAMBA_BIN run -n h4t pip install -r /opt/happy4travian/requirements.txt
              else
                $MAMBA_BIN run -n h4t pip install Flask==3.0.0 gunicorn==21.2.0 SQLAlchemy==1.4.52 pymysql==1.1.0 flask-cors==3.0.10
              fi
              # 确保 dev 端点可用 requests
              $MAMBA_BIN run -n h4t pip install requests || true
              # 明确安装 OCR 相关包避免旧环境缺失
              $MAMBA_BIN run -n h4t pip install Pillow pytesseract imagehash numpy || true
              $MAMBA_BIN run -n h4t python -c "import PIL, pytesseract, imagehash, numpy; print('ocr deps ok', PIL.__version__)" || true
            else
              if [ -f /opt/happy4travian/backend_py/requirements.txt ]; then
                /opt/happy4travian/py311/bin/pip install -r /opt/happy4travian/backend_py/requirements.txt || true
              elif [ -f /opt/happy4travian/requirements.txt ]; then
                /opt/happy4travian/py311/bin/pip install -r /opt/happy4travian/requirements.txt || true
              else
                /opt/happy4travian/py311/bin/pip install Flask==3.0.0 gunicorn==21.2.0 SQLAlchemy==1.4.52 pymysql==1.1.0 flask-cors==3.0.10 || true
              fi
              sudo ln -sf /opt/happy4travian/py311/bin/gunicorn /opt/happy4travian/mamba/envs/h4t/bin/gunicorn || true
              /opt/happy4travian/py311/bin/pip install Pillow pytesseract imagehash numpy || true
              /opt/happy4travian/py311/bin/python -c "import PIL, pytesseract, imagehash, numpy; print('ocr deps ok', PIL.__version__)" || true
            fi
            # 覆盖旧 venv 路径以防 systemd 使用旧环境
            if [ -x /opt/happy4travian/venv/bin/pip ]; then
              /opt/happy4travian/venv/bin/pip install requests || true
              # Python3.6 环境使用旧版 Pillow，避免失败
              /opt/happy4travian/venv/bin/pip install "Pillow==8.4.0" || true
            fi
            sudo bash -lc 'cat > /etc/happy4travian/happy4travian.env <<EOF
            SPRING_DATASOURCE_URL=${{ secrets.DB_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USER }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
            TROOPS_PARAMS_PATH=/opt/happy4travian/backend_py/data/troops_t4.6_1x.json
            EOF'
            sudo systemctl daemon-reload
            sudo systemctl enable happy4travian.service
            sudo systemctl restart happy4travian.service
            if systemctl is-active firewalld >/dev/null 2>&1; then sudo firewall-cmd --permanent --add-port=8080/tcp && sudo firewall-cmd --reload; fi
            for i in 1 2 3 4 5; do
              if (ss -ltnp || netstat -ltnp) | grep 8080 >/dev/null 2>&1; then break; fi
              sleep 2
            done
            echo "==> systemctl status"
            sudo systemctl status happy4travian.service --no-pager || true
            echo "==> journalctl tail"
            sudo journalctl -u happy4travian.service -n 200 --no-pager || true
            echo "==> ps gunicorn"
            ps aux | grep gunicorn || true
            curl -s -o /dev/null -w "health:%{http_code}\n" http://127.0.0.1:8080/api/v1/health || true
            curl -s -o /dev/null -w "db:%{http_code}\n" http://127.0.0.1:8080/api/v1/db/ping || true
            echo "==> troops.py routes"
            grep -n "troops/params" /opt/happy4travian/backend_py/routes/troops.py || true
            grep -n "troops_params" /opt/happy4travian/backend_py/routes/system.py || true
            echo "==> static data file"
            ls -lah /opt/happy4travian/backend_py/data/troops_t4.6_1x.json || true
            head -n 1 /opt/happy4travian/backend_py/data/troops_t4.6_1x.json || true
            echo "==> local curl new endpoints"
            curl -s -o /dev/null -w "tp:%{http_code}\n" http://127.0.0.1:8080/api/v1/troops/params || true
            curl -s -o /dev/null -w "tpa:%{http_code}\n" http://127.0.0.1:8080/api/v1/troops_params || true
            sudo ls -lah /opt/happy4travian/app.log || true
            sudo tail -n 100 /opt/happy4travian/app.log || true
      - name: Generate Excel export (xlsx)
        # 服务器端生成 xlsx 导出文件以验证工具链
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            if /opt/happy4travian/micromamba/bin/micromamba --version >/dev/null 2>&1; then
              /opt/happy4travian/micromamba/bin/micromamba run -n h4t pip install openpyxl || true
              /opt/happy4travian/micromamba/bin/micromamba run -n h4t python /opt/happy4travian/backend_py/tools/export_troops_excel.py || true
            elif [ -x /opt/happy4travian/py311/bin/python ]; then
              /opt/happy4travian/py311/bin/pip install openpyxl || true
              /opt/happy4travian/py311/bin/python /opt/happy4travian/backend_py/tools/export_troops_excel.py || true
            fi
            ls -lah /opt/happy4travian/backend_py/exports || true
      - name: Server-side smoke test (authoritative)
        # 在服务器本地进行 API 冒烟测试
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            echo "==> restart service proactively before smoke"
            sudo systemctl daemon-reload || true
            sudo systemctl restart happy4travian.service || true
            sudo systemctl status happy4travian.service --no-pager || true
            echo "==> check port 8080"
            for i in 1 2 3 4 5 6 7 8 9 10; do if (ss -ltnp || netstat -ltnp) | grep 8080 >/dev/null 2>&1; then echo "port ready"; break; fi; sleep 2; done
            attempt() { curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:8080$1" || echo "000"; }
            for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do h=$(attempt "/api/v1/health"); echo "local-health:$h"; [ "$h" = "200" ] && break; sleep 2; done; [ "$h" = "200" ] || (sudo journalctl -u happy4travian.service -n 200 --no-pager || true; exit 1)
            for ep in "/api/v1/tribes" "/api/v1/servers" "/api/v1/troops/params"; do 
              for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do c=$(attempt "$ep"); echo "local-$ep:$c"; [ "$c" = "200" ] && break; sleep 2; done; [ "$c" = "200" ] || (sudo journalctl -u happy4travian.service -n 200 --no-pager || true; exit 1);
            done
            echo "==> server-side POST body check (non-blocking)"
            curl -s -H 'Content-Type: application/json' -X POST -d '{"nickname":"srv-ci"}' http://127.0.0.1:8080/api/v1/users | tee /tmp/post_users.json || true
            cat /tmp/post_users.json || true

      - name: Server-side E2E (python requests)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            if /opt/happy4travian/micromamba/bin/micromamba --version >/dev/null 2>&1; then
              /opt/happy4travian/micromamba/bin/micromamba run -n h4t pip install requests || true
              /opt/happy4travian/micromamba/bin/micromamba run -n h4t python /opt/happy4travian/backend_py/tools/e2e_requests.py || true
            elif [ -x /opt/happy4travian/py311/bin/python ]; then
              /opt/happy4travian/py311/bin/pip install requests || true
              /opt/happy4travian/py311/bin/python /opt/happy4travian/backend_py/tools/e2e_requests.py || true
            fi
      - name: Seed basic data on server
        # 通过脚本在服务器上灌入基础数据
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            set -a
            [ -f /etc/happy4travian/happy4travian.env ] && . /etc/happy4travian/happy4travian.env || true
            set +a
            if /opt/happy4travian/micromamba/bin/micromamba --version >/dev/null 2>&1; then
              /opt/happy4travian/micromamba/bin/micromamba run -n h4t python /opt/happy4travian/backend_py/tools/seed_basic_data.py || true
            elif [ -x /opt/happy4travian/py311/bin/python ]; then
              /opt/happy4travian/py311/bin/python /opt/happy4travian/backend_py/tools/seed_basic_data.py || true
            fi
            curl -s -o /dev/null -w "alliances:%{http_code}\n" http://127.0.0.1:8080/api/v1/alliances || true
            curl -s -o /dev/null -w "members:%{http_code}\n" http://127.0.0.1:8080/api/v1/alliances/1/members || true
      - name: Run DB migrations (add missing columns)
        # 运行缺失列的迁移脚本并验证接口
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            set -a
            [ -f /etc/happy4travian/happy4travian.env ] && . /etc/happy4travian/happy4travian.env || true
            set +a
            if /opt/happy4travian/micromamba/bin/micromamba --version >/dev/null 2>&1; then
              /opt/happy4travian/micromamba/bin/micromamba run -n h4t python /opt/happy4travian/backend_py/tools/migrations.py || true
            elif [ -x /opt/happy4travian/py311/bin/python ]; then
              /opt/happy4travian/py311/bin/python /opt/happy4travian/backend_py/tools/migrations.py || true
            fi
            curl -s -o /dev/null -w "alliances:%{http_code}\n" http://127.0.0.1:8080/api/v1/alliances || true
      - name: External health probe (JSON)
        # 从 Runner 侧对外部地址进行健康探测
        run: |
          echo "==> probe from runner"
          curl -s -H 'Accept: application/json' http://47.99.88.168:8080/api/v1/health | tee /tmp/health.json ; (grep -q '"success": *true' /tmp/health.json && grep -q '"message": *"ok"' /tmp/health.json) || (test "$(cat /tmp/health.json)" = "ok")
          curl -s -H 'Accept: application/json' http://47.99.88.168:8080/api/v1/db/ping | tee /tmp/dbping.json ; (grep -q '"success": *true' /tmp/dbping.json && grep -q '"message": *"ok"' /tmp/dbping.json) || (test "$(cat /tmp/dbping.json)" = "ok")
          echo "==> external endpoints"
          curl -s http://47.99.88.168:8080/api/v1/tribes | tee /tmp/tribes.json && grep -q '"success": *true' /tmp/tribes.json || exit 1
          curl -s http://47.99.88.168:8080/api/v1/accounts | tee /tmp/accounts.json && grep -q '"success": *true' /tmp/accounts.json || exit 1
          curl -s http://47.99.88.168:8080/api/v1/villages | tee /tmp/villages.json && grep -q '"success": *true' /tmp/villages.json || exit 1
          echo "==> external troops params"
          curl -s 'http://47.99.88.168:8080/api/v1/troops/params?version=1.46&speed=3x' | tee /tmp/tparams.json && grep -q '"success": *true' /tmp/tparams.json || exit 1
      - name: Smoke test (external, non-blocking)
        # 非阻塞的对外接口状态检查
        run: |
          attempt_health() { curl -s -o /dev/null -w "%{http_code}" http://47.99.88.168:8080/api/v1/health || echo "000"; }
          attempt_ep() { curl -s -o /dev/null -w "%{http_code}" "http://47.99.88.168:8080/api/v1/$1" || echo "000"; }
          for i in 1 2 3 4 5 6 7 8 9 10; do code=$(attempt_health); echo "health:$code"; [ "$code" = "200" ] && break; sleep 3; done
          for ep in servers tribes accounts troops/params; do 
            for i in 1 2 3 4 5 6 7 8 9 10; do c=$(attempt_ep "$ep"); echo "$ep:$c"; [ "$c" = "200" ] && break; sleep 3; done
          done
          true