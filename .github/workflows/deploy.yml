name: deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
      - name: Install Maven
        run: sudo apt-get update && sudo apt-get install -y maven
      - name: Build backend jar
        working-directory: backend
        run: mvn -B -DskipTests clean package org.springframework.boot:spring-boot-maven-plugin:3.3.4:repackage
      - name: Verify jar exists
        run: |
          ls -lah backend/target
          test -f backend/target/happy4travian-backend-0.1.0.jar
      - name: Provision Java and firewall on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            sudo yum install -y java-17-openjdk-devel || true
            java -version
            sudo mkdir -p /opt/happy4travian /etc/happy4travian /etc/systemd/system
            if systemctl is-active firewalld >/dev/null 2>&1; then sudo firewall-cmd --permanent --add-port=8080/tcp && sudo firewall-cmd --reload; fi
      - name: Upload jar to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: backend/target/happy4travian-backend-0.1.0.jar
          target: /opt/happy4travian/
      - name: Upload systemd unit
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: ops/systemd/happy4travian.service
          target: /etc/systemd/system/
      - name: DB preflight and create tables
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            DB_URL="${{ secrets.DB_URL }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            DB_HOST=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://([^/:]+).*|\1|')
            DB_PORT=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://[^/:]+:([0-9]+).*|\1|')
            DB_NAME=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://[^/]+/([^?]+).*|\1|')
            [ -z "$DB_PORT" ] && DB_PORT=3306
            sudo yum install -y mariadb || true
            mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\` DEFAULT CHARACTER SET utf8mb4; USE \`$DB_NAME\`; CREATE TABLE IF NOT EXISTS servers ( id BIGINT NOT NULL AUTO_INCREMENT, code VARCHAR(32) NOT NULL, region VARCHAR(32), speed VARCHAR(16), start_date DATE, status VARCHAR(16), PRIMARY KEY (id) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;"
            mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" -e "USE \`$DB_NAME\`; SHOW TABLES;"
      - name: Prepare and restart service
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            sudo mkdir -p /opt/happy4travian /etc/happy4travian
            if [ -f /opt/happy4travian/happy4travian-backend-0.1.0.jar ]; then sudo mv /opt/happy4travian/happy4travian-backend-0.1.0.jar /opt/happy4travian/happy4travian-backend.jar; fi
            sudo bash -lc 'cat > /etc/happy4travian/happy4travian.env <<EOF
            SPRING_DATASOURCE_URL=${{ secrets.DB_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USER }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
            EOF'
            sudo systemctl daemon-reload
            sudo systemctl enable happy4travian.service
            sudo systemctl restart happy4travian.service
            sleep 2
            echo "==> systemctl status"
            sudo systemctl status happy4travian.service --no-pager || true
            echo "==> journalctl tail"
            journalctl -u happy4travian.service -n 200 --no-pager || true
            echo "==> listening sockets"
            (ss -ltnp || netstat -ltnp) | grep 8080 || true
            curl -s http://127.0.0.1:8080/api/v1/health || true
      - name: Integration verify and seed sample
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            for i in 1 2 3 4 5; do
              if curl -s --fail http://127.0.0.1:8080/api/v1/health >/dev/null; then break; fi
              sleep 3
            done
            LIST=$(curl -s http://127.0.0.1:8080/api/v1/servers || echo "")
            echo "servers before: $LIST"
            if echo "$LIST" | grep -q "^\[\]$"; then
              # try JSON API seed
              curl -s -H 'Content-Type: application/json' -X POST -d '{"code":"ci-probe","region":"CN","speed":"x1","startDate":"2025-11-01"}' http://127.0.0.1:8080/api/v1/servers || true
              sleep 2
              AFTER=$(curl -s http://127.0.0.1:8080/api/v1/servers || echo "")
              echo "servers after API seed: $AFTER"
              if echo "$AFTER" | grep -q "^\[\]$"; then
                # fallback SQL seed
                DB_URL="${{ secrets.DB_URL }}"; DB_USER="${{ secrets.DB_USER }}"; DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
                DB_HOST=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://([^/:]+).*|\1|'); DB_PORT=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://[^/:]+:([0-9]+).*|\1|'); DB_NAME=$(echo "$DB_URL" | sed -E 's|jdbc:mysql://[^/]+/([^?]+).*|\1|'); [ -z "$DB_PORT" ] && DB_PORT=3306
                mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" -e "USE \`$DB_NAME\`; INSERT INTO servers(code,region,speed,start_date,status) VALUES('ci-probe','CN','x1','2025-11-01','active');"
              fi
            fi
            curl -s http://127.0.0.1:8080/api/v1/servers || true
      - name: External health probe
        run: |
          echo "==> probe from runner"
          curl -s -o /dev/null -w "HTTP:%{http_code} BYTES:%{size_download}\n" http://47.99.88.168:8080/api/v1/health || true